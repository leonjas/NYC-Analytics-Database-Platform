<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics: {{ data.bbl }} - NYC Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background-color: #336699;
            color: white;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .header h1 {
            margin: 0;
        }
        
        .nav-bar {
            background-color: white;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
        }
        
        .nav-bar a {
            color: #336699;
            margin-right: 15px;
            text-decoration: none;
        }
        
        .nav-bar a:hover {
            text-decoration: underline;
        }
        
        .bookmark-btn {
            background-color: #336699;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            float: right;
        }
        
        .bookmark-btn.bookmarked {
            background-color: green;
        }
        
        .card {
            background-color: white;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
        }
        
        .card h2 {
            margin-top: 0;
            color: #336699;
            border-bottom: 2px solid #336699;
            padding-bottom: 5px;
        }
        
        .stat-box {
            background-color: #e6f2ff;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
        }
        
        .complaint-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .count-badge {
            background-color: #336699;
            color: white;
            padding: 5px 10px;
            float: right;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f0f0f0;
        }
        
        button {
            background-color: #336699;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #224466;
        }
        
        .export-btn {
            background-color: green;
        }
        
        .toggle-btn {
            background-color: white;
            color: #336699;
            border: 1px solid #336699;
        }
        
        .toggle-btn.active {
            background-color: #336699;
            color: white;
        }
        
        .chart-container {
            display: none;
            margin-top: 20px;
        }
        
        .chart-container.active {
            display: block;
        }
        
        .no-data {
            text-align: center;
            padding: 20px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>BBL {{ data.bbl }}</h1>
        <div>{{ data.borough_name }} | {{ start_date }} to {{ end_date }}</div>
    </div>
    
    <div class="nav-bar">
        <a href="/">Home</a>
        <a href="/bookmarks">Bookmarks</a>
        {% if first_address %}
        {% set parts = first_address.split(none, 1) %}
        {% if parts|length >= 2 %}
        {% set street_clean = parts[1].split(',')[0] %}
        <a href="/compare?house_number1={{ parts[0] }}&street1={{ street_clean }}&borough1={{ data.borough_name }}&start_date={{ start_date }}&end_date={{ end_date }}">Compare</a>
        {% else %}
        <a href="/compare?borough1={{ data.borough_name }}&start_date={{ start_date }}&end_date={{ end_date }}">Compare</a>
        {% endif %}
        {% else %}
        <a href="/compare?borough1={{ data.borough_name }}&start_date={{ start_date }}&end_date={{ end_date }}">Compare</a>
        {% endif %}
        
        <button class="bookmark-btn {% if is_bookmarked %}bookmarked{% endif %}" 
                onclick="toggleBookmark('{{ data.bbl }}')">
            {% if is_bookmarked %}Bookmarked{% else %}Bookmark{% endif %}
        </button>
    </div>
        
    <!-- Statistics -->
    <div class="card">
        <h2>Service Requests</h2>
        <div class="stat-box">
            <div class="stat-number">{{ '{:,}'.format(data.total_requests) }}</div>
            <div>Total Requests</div>
        </div>
        <div class="stat-box">
            <div class="stat-number">{{ '{:,}'.format(data.total_active) }}</div>
            <div>Active Requests</div>
        </div>
    </div>
    
    <div class="card">
        <h2>Property Sales</h2>
        <div class="stat-box">
            <div class="stat-number">{{ '{:,}'.format(data.num_sales) }}</div>
            <div>Total Sales</div>
        </div>
        {% if data.num_sales > 0 %}
        <div class="stat-box">
            <div class="stat-number">${{ '{:,.0f}'.format(data.median_sale_price) }}</div>
            <div>Median Sale Price</div>
        </div>
        <p><strong>Min:</strong> ${{ '{:,.0f}'.format(data.min_sale_price) }}</p>
        <p><strong>Max:</strong> ${{ '{:,.0f}'.format(data.max_sale_price) }}</p>
        {% else %}
        <div class="no-data">No sales data</div>
        {% endif %}
    </div>
    
    <!-- Complaints -->
    <div class="card">
        <h2>Service Requests by Type</h2>
        {% if data.complaint_types %}
            <button class="export-btn" onclick="exportCSV('{{ data.bbl }}', 'complaints', '{{ start_date }}', '{{ end_date }}')">
                Export CSV
            </button>
            
            <div style="max-width: 500px; margin: 20px auto;">
                <canvas id="complaintPieChart"></canvas>
            </div>
            
            <div style="margin-top: 20px;">
                {% for ct in data.complaint_types %}
                <div class="complaint-item">
                    <span>{{ ct.type }}</span>
                    <span class="count-badge">{{ ct.count }}</span>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-data">No service requests</div>
        {% endif %}
    </div>
        
    <!-- Sales Table -->
    {% if data.sales %}
    <div class="card">
        <h2>Recent Property Sales</h2>
        <button class="export-btn" onclick="exportCSV('{{ data.bbl }}', 'sales', '{{ start_date }}', '{{ end_date }}')">
            Export CSV
        </button>
        
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Address</th>
                    <th>Sale Price</th>
                </tr>
            </thead>
            <tbody>
                {% for sale in data.sales[:10] %}
                <tr>
                    <td>{{ sale.date }}</td>
                    <td>{{ sale.address }}</td>
                    <td>${{ '{:,.0f}'.format(sale.price) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if data.sales|length > 10 %}
        <p>Showing 10 of {{ data.sales|length }} total sales</p>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Trends -->
    <div class="card">
        <h2>Trends Over Time</h2>
        <div>
            <button class="toggle-btn active" onclick="showTrendsType('service_requests')">Service Requests</button>
            <button class="toggle-btn" onclick="showTrendsType('sales')">Property Sales</button>
        </div>
        
        <div id="service-requests-trends" class="chart-container active">
            <canvas id="serviceRequestsTrendsChart"></canvas>
        </div>
        
        <div id="property-sales-trends" class="chart-container">
            <canvas id="propertySalesTrendsChart"></canvas>
        </div>
    </div>
</body>
    
    <script>
        var serviceChart = null;
        var salesChart = null;
        var pieChart = null;
        
        // When page loads
        window.onload = function() {
            loadCharts();
        };
        
        function loadCharts() {
            loadServiceRequestsChart();
            loadSalesChart();
            loadPieChart();
        }
        
        function toggleBookmark(bbl) {
            fetch('/bookmark/' + bbl, { method: 'POST' })
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    window.location.reload();
                });
        }
        
        function exportCSV(bbl, type, startDate, endDate) {
            window.location.href = '/export/' + bbl + '?type=' + type + '&start_date=' + startDate + '&end_date=' + endDate;
        }
        
        function loadPieChart() {
            var canvas = document.getElementById('complaintPieChart');
            if (!canvas) return;
            
            var ctx = canvas.getContext('2d');
            
            var complaintData = [
                {% for ct in complaint_data %}
                    {type: "{{ ct.type }}", count: {{ ct.count }} }{% if not loop.last %},{% endif %}
                {% endfor %}
            ];
            
            if (complaintData.length === 0) return;
            
            var labels = [];
            var counts = [];
            for (var i = 0; i < complaintData.length; i++) {
                labels.push(complaintData[i].type);
                counts.push(complaintData[i].count);
            }
            
            var colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
            
            pieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }
        
        function showTrendsType(type) {
            var buttons = document.querySelectorAll('.toggle-btn');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove('active');
            }
            event.target.classList.add('active');
            
            if (type === 'service_requests') {
                document.getElementById('service-requests-trends').classList.add('active');
                document.getElementById('property-sales-trends').classList.remove('active');
            } else {
                document.getElementById('service-requests-trends').classList.remove('active');
                document.getElementById('property-sales-trends').classList.add('active');
            }
        }
        
        function loadServiceRequestsChart() {
            fetch('/trends/{{ data.bbl }}?type=service_requests&start_date={{ start_date }}&end_date={{ end_date }}')
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    var ctx = document.getElementById('serviceRequestsTrendsChart').getContext('2d');
                    
                    if (data.length === 0) return;
                    
                    var months = [];
                    var counts = [];
                    for (var i = 0; i < data.length; i++) {
                        months.push(data[i].month);
                        counts.push(data[i].count);
                    }
                    
                    serviceChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [{
                                label: 'Service Requests',
                                data: counts,
                                borderColor: '#336699',
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true
                        }
                    });
                });
        }
        
        function loadSalesChart() {
            fetch('/trends/{{ data.bbl }}?type=sales&start_date={{ start_date }}&end_date={{ end_date }}')
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    var ctx = document.getElementById('propertySalesTrendsChart').getContext('2d');
                    
                    if (data.length === 0) return;
                    
                    var months = [];
                    var prices = [];
                    for (var i = 0; i < data.length; i++) {
                        months.push(data[i].month);
                        prices.push(data[i].median_price);
                    }
                    
                    salesChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [{
                                label: 'Median Sale Price',
                                data: prices,
                                borderColor: 'green',
                                fill: false,
                                spanGaps: true
                            }]
                        },
                        options: {
                            responsive: true
                        }
                    });
                });
        }
    </script>
</body>
</html>
